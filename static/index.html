<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>RetailBot ‚Ä¢ Smart Document Assistant</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --green:      #4a5e42;
      --green-dark: #39492f;
      --green-xd:   #2c3824;
      --green-lt:   #6b7f62;
      --gold:       #e8d49a;
      --gold-dk:    #c9b47a;
      --gold-lt:    #f5ecca;
      --cream:      #f7f4ef;
      --cream-dk:   #ece7df;
      --stone:      #c8bdb5;
      --muted:      #9a9490;
      --ink:        #22271e;
      --white:      #ffffff;
      --sidebar-w:  320px;
      --hdr-h:      66px;
      --r-sm: 10px; --r-md: 18px; --r-lg: 28px;
      --sh-sm: 0 2px 10px rgba(0,0,0,.07);
      --sh-md: 0 6px 24px rgba(0,0,0,.11);
      --sh-lg: 0 18px 52px rgba(0,0,0,.18);
      --ease: all .22s cubic-bezier(.4,0,.2,1);
    }

    html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); overflow: hidden; }
    .app { display: flex; height: 100dvh; overflow: hidden; }
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(3px); z-index:40; transition:opacity .25s; }
    .overlay.active { display:block; }

    /* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
    .sidebar {
      width: var(--sidebar-w); min-width: var(--sidebar-w);
      background: linear-gradient(175deg, var(--green-xd) 0%, var(--green-dark) 55%, var(--green) 100%);
      display: flex; flex-direction: column; height: 100%; overflow: hidden;
      position: relative; z-index: 50;
      transition: transform .3s cubic-bezier(.4,0,.2,1);
    }
    .sidebar::before {
      content:''; position:absolute; inset:0; pointer-events:none; z-index:0;
      background-image: radial-gradient(circle, rgba(255,255,255,.055) 1px, transparent 1px);
      background-size: 22px 22px;
    }
    .sidebar-inner {
      position:relative; z-index:1; display:flex; flex-direction:column;
      height:100%; overflow-y:auto; overflow-x:hidden; padding:22px 18px 26px;
      scrollbar-width:thin; scrollbar-color:rgba(255,255,255,.12) transparent;
    }
    .sidebar-inner::-webkit-scrollbar { width:3px; }
    .sidebar-inner::-webkit-scrollbar-thumb { background:rgba(255,255,255,.15); border-radius:3px; }

    /* LOGO */
    .logo { display:flex; align-items:center; gap:13px; padding-bottom:22px; border-bottom:1px solid rgba(255,255,255,.1); margin-bottom:20px; }
    .logo-mark {
      width:54px; height:54px; flex-shrink:0;
      background: var(--gold);
      border-radius:18px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 22px rgba(0,0,0,.28), 0 0 0 2px rgba(255,255,255,.12), inset 0 1px 0 rgba(255,255,255,.35);
      animation:logoFloat 5s ease-in-out infinite;
      position:relative; overflow:hidden;
    }
    .logo-mark::after { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,.3) 0%,transparent 55%); border-radius:inherit; pointer-events:none; }
    @keyframes logoFloat { 0%,100%{transform:translateY(0) rotate(0);} 50%{transform:translateY(-5px) rotate(1.5deg);} }
    .logo-mark svg { width:32px; height:32px; position:relative; z-index:1; }
    .logo-text h1 { font-family:'Playfair Display',serif; font-size:1.55rem; font-weight:700; color:var(--gold); line-height:1.1; letter-spacing:-.3px; }
    .logo-text p  { font-size:.68rem; font-weight:500; color:rgba(255,255,255,.5); text-transform:uppercase; letter-spacing:1.1px; margin-top:4px; }

    /* SECTION LABEL */
    .sec-label { display:flex; align-items:center; gap:7px; font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:1.3px; color:rgba(255,255,255,.38); margin-bottom:10px; margin-top:4px; }
    .sec-label .si { width:20px; height:20px; background:rgba(232,212,154,.18); border-radius:6px; display:flex; align-items:center; justify-content:center; color:var(--gold); font-size:.65rem; }

    /* UPLOAD CARD */
    .upload-card { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:var(--r-lg); padding:16px 14px; margin-bottom:18px; transition:var(--ease); }
    .upload-card:hover { background:rgba(255,255,255,.09); }

    .drop-zone { border:2px dashed rgba(255,255,255,.2); border-radius:var(--r-md); padding:28px 14px 22px; text-align:center; cursor:pointer; transition:var(--ease); position:relative; overflow:hidden; }
    .drop-zone.dragover { border-color:var(--gold); background:rgba(232,212,154,.1); transform:scale(1.01); }
    .drop-zone:hover    { border-color:rgba(232,212,154,.5); background:rgba(255,255,255,.04); }

    .dz-ring {
      width:64px; height:64px; margin:0 auto 13px;
      border-radius:50%;
      background:rgba(232,212,154,.13);
      border:2px solid rgba(232,212,154,.25);
      display:flex; align-items:center; justify-content:center;
      transition:var(--ease);
    }
    .drop-zone:hover .dz-ring { transform:translateY(-6px) scale(1.1); background:rgba(232,212,154,.22); border-color:rgba(232,212,154,.5); }
    .dz-ring svg { width:30px; height:30px; }
    .drop-zone p   { color:rgba(255,255,255,.85); font-size:.87rem; font-weight:600; }
    .drop-zone small { color:rgba(255,255,255,.4); font-size:.73rem; display:block; margin-top:5px; }
    #fileInput { display:none; }

    .file-preview { display:none; align-items:center; gap:10px; margin-top:11px; padding:10px 12px; background:rgba(232,212,154,.1); border:1px solid rgba(232,212,154,.28); border-radius:14px; animation:slideUp .25s ease; }
    .file-preview.visible { display:flex; }
    @keyframes slideUp { from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);} }
    .fp-ico { width:36px; height:36px; background:var(--gold); border-radius:10px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .fp-ico svg { width:18px; height:18px; }
    .fp-name { font-weight:600; font-size:.81rem; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fp-size { font-size:.69rem; color:rgba(255,255,255,.5); }
    .fp-rm { margin-left:auto; background:rgba(255,255,255,.1); border:none; cursor:pointer; color:rgba(255,255,255,.7); width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:var(--ease); flex-shrink:0; }
    .fp-rm svg { width:13px; height:13px; }
    .fp-rm:hover { background:rgba(220,80,80,.3); color:white; }

    .btn-upload { width:100%; margin-top:13px; padding:13px; background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dk) 100%); color:var(--green-xd); border:none; border-radius:14px; font-family:'DM Sans',sans-serif; font-size:.92rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 14px rgba(0,0,0,.22),inset 0 1px 0 rgba(255,255,255,.4); transition:var(--ease); }
    .btn-upload:hover { transform:translateY(-2px); box-shadow:0 8px 22px rgba(0,0,0,.28); filter:brightness(1.05); }
    .btn-upload:active { transform:translateY(0); }
    .btn-upload:disabled { opacity:.45; pointer-events:none; }
    .btn-upload svg { width:16px; height:16px; }

    .upload-progress { display:none; height:4px; background:rgba(255,255,255,.1); border-radius:4px; margin-top:9px; overflow:hidden; }
    .upload-progress.on { display:block; }
    .uprog-bar { height:100%; background:linear-gradient(90deg,var(--gold-dk),var(--gold)); border-radius:4px; width:0%; transition:width .4s; animation:shimmer 1.8s ease infinite; }
    @keyframes shimmer { 0%,100%{filter:brightness(1);}50%{filter:brightness(1.25);} }

    .ustat { display:none; margin-top:9px; padding:9px 12px; border-radius:10px; font-size:.8rem; font-weight:500; line-height:1.45; white-space:pre-line; animation:fadeScale .25s; }
    @keyframes fadeScale{from{opacity:0;transform:scale(.97);}to{opacity:1;transform:scale(1);}}
    .ustat.success { display:flex; gap:8px; align-items:flex-start; background:rgba(80,180,80,.1); color:#a0dfa0; border:1px solid rgba(80,180,80,.2); }
    .ustat.error   { display:flex; gap:8px; align-items:flex-start; background:rgba(220,80,80,.1); color:#f5a5a5; border:1px solid rgba(220,80,80,.2); }
    .ustat.loading { display:flex; gap:8px; align-items:center;     background:rgba(232,212,154,.09); color:var(--gold); border:1px solid rgba(232,212,154,.22); }
    .ustat svg { width:14px; height:14px; flex-shrink:0; margin-top:1px; }
    .spin { animation:spinR 1s linear infinite; }
    @keyframes spinR{to{transform:rotate(360deg);}}

    /* DOC CARD */
    .doc-card { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:var(--r-lg); padding:14px; margin-bottom:18px; }
    .doc-item { display:flex; align-items:center; gap:9px; padding:10px 11px; border-radius:10px; background:rgba(255,255,255,.04); font-size:.83rem; color:rgba(255,255,255,.6); transition:var(--ease); }
    .doc-item.active { background:rgba(232,212,154,.11); border:1px solid rgba(232,212,154,.28); color:white; }
    .doc-item svg { flex-shrink:0; width:18px; height:18px; }
    .doc-item .doc-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; min-width:0; }
    .doc-badge { background:var(--gold); color:var(--green-xd); padding:3px 9px; border-radius:20px; font-size:.62rem; font-weight:800; text-transform:uppercase; letter-spacing:.5px; flex-shrink:0; animation:pulseBadge 2.5s ease infinite; }
    @keyframes pulseBadge{0%,100%{opacity:1;}50%{opacity:.7;}}

    .conf-panel { display:none; margin-top:11px; padding:11px; background:rgba(255,255,255,.04); border-radius:10px; border:1px solid rgba(255,255,255,.08); animation:slideUp .3s; }
    .conf-panel.on { display:block; }
    .conf-lbl { font-size:.73rem; color:rgba(255,255,255,.5); margin-bottom:7px; display:flex; align-items:center; gap:6px; }
    .conf-lbl strong { color:var(--gold); }
    .conf-bar { height:5px; background:rgba(255,255,255,.1); border-radius:3px; overflow:hidden; }
    .conf-fill { height:100%; background:linear-gradient(90deg,var(--gold-dk),var(--gold)); border-radius:3px; transition:width .7s ease; }
    .cat-tags { display:flex; flex-wrap:wrap; gap:5px; margin-top:9px; }
    .cat-tag { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); color:rgba(255,255,255,.65); padding:3px 10px; border-radius:20px; font-size:.69rem; display:flex; align-items:center; gap:4px; transition:var(--ease); }
    .cat-tag svg { width:10px; height:10px; }
    .cat-tag:hover { background:var(--gold); color:var(--green-xd); border-color:var(--gold); }

    /* SIDEBAR FOOTER */
    .sf { margin-top:auto; padding-top:18px; border-top:1px solid rgba(255,255,255,.08); }
    .sf-model { display:flex; align-items:center; gap:9px; background:rgba(255,255,255,.06); border-radius:12px; padding:10px 12px; }
    .sf-model-ico { width:30px; height:30px; background:rgba(232,212,154,.15); border-radius:9px; display:flex; align-items:center; justify-content:center; }
    .sf-model-ico svg { width:14px; height:14px; }
    .sf-model-txt { font-size:.73rem; color:rgba(255,255,255,.5); }
    .sf-model-txt strong { color:rgba(255,255,255,.8); font-weight:600; display:block; font-size:.76rem; }
    .sf-dot { width:7px; height:7px; background:#5cba6e; border-radius:50%; margin-left:auto; flex-shrink:0; animation:pulseDot 2s ease infinite; }
    @keyframes pulseDot{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.6);opacity:.5;}}

    /* ‚ïê‚ïê‚ïê CHAT AREA ‚ïê‚ïê‚ïê */
    .chat-area { flex:1; display:flex; flex-direction:column; min-width:0; background:var(--cream); }

    /* HEADER */
    .chat-header { height:var(--hdr-h); background:white; border-bottom:1px solid var(--cream-dk); padding:0 22px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-shrink:0; box-shadow:0 1px 8px rgba(0,0,0,.05); position:relative; z-index:10; }
    .hdr-left { display:flex; align-items:center; gap:11px; min-width:0; }
    .hamburger { display:none; background:var(--cream); border:1px solid var(--cream-dk); color:var(--green); width:38px; height:38px; border-radius:var(--r-sm); cursor:pointer; align-items:center; justify-content:center; font-size:1rem; transition:var(--ease); flex-shrink:0; }
    .hamburger svg { width:18px; height:18px; }
    .hamburger:hover { background:var(--green); color:white; border-color:var(--green); }

    .hdr-brand { display:flex; align-items:center; gap:10px; min-width:0; }
    .hdr-brand-mark { width:38px; height:38px; background:var(--green); border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:var(--sh-sm); }
    .hdr-brand-mark svg { width:22px; height:22px; }
    .hdr-brand-text h2 { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hdr-brand-text p { font-size:.7rem; color:var(--muted); margin-top:1px; white-space:nowrap; }

    .hdr-right { display:flex; align-items:center; gap:7px; flex-shrink:0; }


    .hdr-btn { background:var(--cream); border:1px solid var(--cream-dk); color:var(--muted); height:36px; padding:0 12px; border-radius:var(--r-sm); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; font-size:.78rem; font-weight:500; transition:var(--ease); white-space:nowrap; font-family:'DM Sans',sans-serif; }
    .hdr-btn svg { width:14px; height:14px; }
    .hdr-btn:hover { border-color:#c0392b; color:#c0392b; background:rgba(192,57,43,.06); }

    /* MESSAGES */
    .chat-messages { flex:1; overflow-y:auto; padding:26px 22px; display:flex; flex-direction:column; gap:18px; scroll-behavior:smooth; }
    .chat-messages::-webkit-scrollbar { width:5px; }
    .chat-messages::-webkit-scrollbar-thumb { background:var(--stone); border-radius:5px; }
    .chat-messages::-webkit-scrollbar-thumb:hover { background:var(--green-lt); }

    /* WELCOME */
    .welcome-state { margin:auto; text-align:center; max-width:440px; padding:16px; animation:fadeIn .5s ease; }
    @keyframes fadeIn{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
    .ws-logo { width:82px; height:82px; margin:0 auto 20px; background:linear-gradient(135deg,var(--green),var(--green-lt)); border-radius:28px; display:flex; align-items:center; justify-content:center; box-shadow:var(--sh-md); position:relative; overflow:hidden; }
    .ws-logo::after { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,.2) 0%,transparent 60%); }
    .ws-logo svg { width:44px; height:44px; position:relative; z-index:1; }
    .welcome-state h3 { font-family:'Playfair Display',serif; font-size:1.4rem; color:var(--ink); margin-bottom:10px; }
    .welcome-state > p { font-size:.89rem; color:var(--muted); line-height:1.65; }

    .ws-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:18px; text-align:left; }
    .ws-card { background:white; border:1px solid var(--cream-dk); border-radius:12px; padding:11px 12px; cursor:pointer; display:flex; align-items:flex-start; gap:9px; transition:var(--ease); }
    .ws-card:hover { border-color:var(--green); transform:translateY(-2px); box-shadow:var(--sh-sm); }
    .ws-card-ico { width:28px; height:28px; border-radius:8px; background:var(--cream); flex-shrink:0; display:flex; align-items:center; justify-content:center; }
    .ws-card-ico svg { width:14px; height:14px; color:var(--green); }
    .ws-card-text strong { font-size:.8rem; font-weight:600; color:var(--ink); display:block; }
    .ws-card-text span   { font-size:.72rem; color:var(--muted); }

    /* MESSAGES */
    .message { display:flex; gap:9px; max-width:80%; animation:msgIn .3s cubic-bezier(.4,0,.2,1); }
    @keyframes msgIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .message.user { align-self:flex-end; flex-direction:row-reverse; }
    .message.bot  { align-self:flex-start; }
    .msg-av { width:36px; height:36px; border-radius:12px; flex-shrink:0; display:flex; align-items:center; justify-content:center; box-shadow:var(--sh-sm); }
    .message.user .msg-av { background:var(--green); }
    .message.bot  .msg-av { background:white; border:1px solid var(--cream-dk); }
    .msg-av svg { width:18px; height:18px; }
    .msg-body { display:flex; flex-direction:column; gap:4px; min-width:0; }
    .msg-content { padding:12px 16px; border-radius:20px; font-size:.92rem; line-height:1.66; word-break:break-word; transition:box-shadow .2s; }
    .message.user .msg-content { background:var(--green); color:white; border-radius:20px 4px 20px 20px; }
    .message.bot  .msg-content { background:white; color:var(--ink); border:1px solid var(--cream-dk); border-radius:4px 20px 20px 20px; box-shadow:var(--sh-sm); }
    .message.bot .msg-content:hover { box-shadow:var(--sh-md); }
    .msg-content h1,.msg-content h2,.msg-content h3{margin:.5em 0 .25em;font-weight:600;}
    .msg-content p{margin:.35em 0;}
    .msg-content ul,.msg-content ol{margin:.35em 0 .35em 1.4em;}
    .msg-content li{margin:.2em 0;}
    .msg-content code{background:rgba(0,0,0,.07);padding:.15em .4em;border-radius:5px;font-size:.84em;}
    .msg-content pre{background:rgba(0,0,0,.04);padding:.8em;border-radius:10px;overflow-x:auto;margin:.4em 0;}
    .message.user .msg-content code{background:rgba(255,255,255,.2);}
    .message.user .msg-content pre{background:rgba(255,255,255,.12);}

    .msg-sources { font-size:.73rem; color:var(--muted); display:flex; align-items:center; gap:5px; flex-wrap:wrap; padding:4px 6px; }
    .msg-sources svg { width:11px; height:11px; }
    .src-pill { background:var(--cream-dk); color:var(--green); border-radius:12px; padding:2px 8px; font-size:.68rem; font-weight:700; }
    .msg-time { font-size:.66rem; color:var(--stone); padding:0 6px; }
    .message.user .msg-time { text-align:right; }

    .typing-indicator { display:flex; gap:5px; padding:14px 18px; background:white; border:1px solid var(--cream-dk); border-radius:4px 20px 20px 20px; width:fit-content; box-shadow:var(--sh-sm); }
    .typing-indicator span { width:7px; height:7px; background:var(--green-lt); border-radius:50%; animation:typeBounce 1.2s infinite; }
    .typing-indicator span:nth-child(2){animation-delay:.15s;}
    .typing-indicator span:nth-child(3){animation-delay:.3s;}
    @keyframes typeBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-7px);}}

    /* INPUT AREA */
    .chat-input-wrap { background:white; border-top:1px solid var(--cream-dk); padding:12px 18px 16px; flex-shrink:0; }
    .chips-row { display:flex; gap:6px; overflow-x:auto; padding-bottom:10px; scrollbar-width:none; }
    .chips-row::-webkit-scrollbar{display:none;}
    .q-chip { background:var(--cream); border:1px solid var(--cream-dk); color:var(--green); padding:6px 12px; border-radius:20px; font-size:.77rem; font-weight:500; cursor:pointer; white-space:nowrap; flex-shrink:0; display:flex; align-items:center; gap:5px; transition:var(--ease); font-family:'DM Sans',sans-serif; }
    .q-chip svg { width:11px; height:11px; }
    .q-chip:hover { background:var(--green); color:white; border-color:var(--green); }

    .input-row { display:flex; align-items:flex-end; gap:7px; background:var(--cream); border:2px solid var(--cream-dk); border-radius:28px; padding:8px 8px 8px 16px; transition:var(--ease); }
    .input-row:focus-within { border-color:var(--green); background:white; box-shadow:0 0 0 3px rgba(74,94,66,.08); }
    #question { flex:1; border:none; background:transparent; font-family:'DM Sans',sans-serif; font-size:.94rem; color:var(--ink); outline:none; resize:none; max-height:120px; line-height:1.5; padding:4px 0; scrollbar-width:thin; }
    #question::placeholder { color:var(--stone); }

    .input-actions { display:flex; align-items:center; gap:5px; }
    .act-btn { width:36px; height:36px; border:none; background:transparent; color:var(--stone); border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--ease); flex-shrink:0; }
    .act-btn svg { width:17px; height:17px; }
    .act-btn:hover { background:var(--cream-dk); color:var(--green); }

    .send-btn { width:44px; height:44px; background:linear-gradient(135deg,var(--green) 0%,var(--green-dark) 100%); color:white; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 3px 12px rgba(74,94,66,.35); transition:var(--ease); }
    .send-btn svg { width:18px; height:18px; }
    .send-btn:hover { transform:scale(1.08) rotate(6deg); box-shadow:0 6px 18px rgba(74,94,66,.4); }
    .send-btn:active { transform:scale(.95); }
    .send-btn:disabled { opacity:.35; pointer-events:none; }

    .input-hint { font-size:.68rem; color:var(--stone); text-align:center; margin-top:7px; display:flex; align-items:center; justify-content:center; gap:4px; }
    kbd { background:var(--cream-dk); padding:1px 5px; border-radius:4px; font-size:.66rem; border:1px solid var(--stone); font-family:'DM Sans',sans-serif; }

    /* TOASTS */
    .toast-con { position:fixed; top:18px; right:18px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
    .toast { padding:11px 16px; border-radius:10px; font-size:.85rem; font-weight:500; color:white; box-shadow:var(--sh-lg); pointer-events:auto; animation:toastIn .3s ease; max-width:300px; display:flex; align-items:center; gap:9px; }
    .toast svg { width:16px; height:16px; flex-shrink:0; }
    @keyframes toastIn{from{opacity:0;transform:translateX(18px);}to{opacity:1;transform:translateX(0);}}
    .toast.success { background:var(--green-dark); }
    .toast.error   { background:#a93226; }
    .toast.info    { background:#1a5276; }

    /* RESPONSIVE */
    @media(max-width:900px){ :root{--sidebar-w:290px;} }
    @media(max-width:768px){
      .sidebar { position:fixed; left:0; top:0; bottom:0; transform:translateX(-100%); z-index:50; box-shadow:var(--sh-lg); }
      .sidebar.open { transform:translateX(0); }
      .overlay { display:none; } .overlay.active { display:block; }
      .hamburger { display:flex; }
      .status-pill span { display:none; }
      .chat-messages { padding:16px 13px; }
      .message { max-width:92%; }
      .chat-input-wrap { padding:10px 13px 14px; }
      .chat-header { padding:0 13px; }
      .ws-grid { grid-template-columns:1fr; }
    }
    @media(max-width:480px){
      .hdr-brand-text p { display:none; }
      .message { max-width:96%; }
      .msg-content { font-size:.87rem; padding:10px 13px; }
      .hdr-btn span { display:none; }
      .chips-row { display:none; }
      .input-hint { display:none; }
    }
    ::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--stone);border-radius:5px;}
    @keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-5px);}40%,80%{transform:translateX(5px);}}
  </style>
</head>
<body>

<div class="toast-con" id="toastCon"></div>
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-inner">

  <!-- Custom RetailBot Logo -->
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Shopping bag silhouette -->
        <path d="M14 24 Q12 24 11 26 L7 52 Q6 54 8 54 H56 Q58 54 57 52 L53 26 Q52 24 50 24 Z" fill="#2c3824" opacity=".9"/>
        <!-- Bag handle arc -->
        <path d="M22 24 C22 14 42 14 42 24" stroke="#2c3824" stroke-width="4.5" stroke-linecap="round" fill="none"/>
        <!-- Inner shimmer strip -->
        <rect x="11" y="24" width="42" height="11" rx="3" fill="white" opacity=".07"/>
        <!-- AI circuit nodes -->
        <circle cx="24" cy="40" r="4" fill="#e8d49a"/>
        <circle cx="40" cy="40" r="4" fill="#e8d49a"/>
        <circle cx="32" cy="49" r="4" fill="#e8d49a"/>
        <!-- Circuit lines -->
        <line x1="24" y1="40" x2="40" y2="40" stroke="#e8d49a" stroke-width="1.8" stroke-linecap="round"/>
        <line x1="24" y1="40" x2="32" y2="49" stroke="#e8d49a" stroke-width="1.8" stroke-linecap="round"/>
        <line x1="40" y1="40" x2="32" y2="49" stroke="#e8d49a" stroke-width="1.8" stroke-linecap="round"/>
        <!-- Central hub dot -->
        <circle cx="32" cy="32" r="3" fill="#e8d49a" opacity=".55"/>
        <line x1="32" y1="35" x2="32" y2="36" stroke="#e8d49a" stroke-width="1.5" opacity=".45"/>
        <line x1="27" y1="32" x2="29" y2="32" stroke="#e8d49a" stroke-width="1.5" opacity=".4"/>
        <line x1="35" y1="32" x2="37" y2="32" stroke="#e8d49a" stroke-width="1.5" opacity=".4"/>
      </svg>
    </div>
    <div class="logo-text">
      <h1>RetailBot</h1>
      <p>Smart Document Assistant</p>
    </div>
  </div>

  <!-- Upload -->
  <div class="sec-label">
    <div class="si"><i class="fas fa-cloud-upload-alt"></i></div>
    Upload Document
  </div>
  <div class="upload-card">
    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="dz-ring">
        <!-- PDF + cloud up icon composite -->
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 10a4 4 0 0 1 4-4h18l10 10v24a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4V10z" stroke="#e8d49a" stroke-width="2.5" fill="rgba(232,212,154,.08)"/>
          <path d="M30 6v10h10" stroke="#e8d49a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M24 40V27m0 0-5 5m5-5 5 5" stroke="#e8d49a" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <p>Click or drag &amp; drop your PDF</p>
      <small>Retail documents only &bull; Max 10 MB</small>
    </div>
    <input type="file" id="fileInput" accept=".pdf" />

    <div class="file-preview" id="filePreview">
      <div class="fp-ico">
        <svg viewBox="0 0 24 24" fill="none" stroke="#2c3824" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
        </svg>
      </div>
      <div style="flex:1;min-width:0">
        <div class="fp-name" id="fpName">document.pdf</div>
        <div class="fp-size" id="fpSize">0 KB</div>
      </div>
      <button class="fp-rm" id="fpRm" title="Remove">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <button class="btn-upload" id="uploadBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/>
        <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/>
      </svg>
      Upload Document
    </button>

    <div class="upload-progress" id="uploadProgress"><div class="uprog-bar" id="uProgBar"></div></div>
    <div class="ustat" id="uStat"></div>
  </div>

  <!-- Active Document -->
  <div class="sec-label">
    <div class="si"><i class="fas fa-folder-open"></i></div>
    Active Document
  </div>
  <div class="doc-card">
    <div class="doc-item" id="docItem">
      <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
      </svg>
      <span class="doc-name">No document uploaded</span>
    </div>
    <div class="conf-panel" id="confPanel">
      <div class="conf-lbl">
        <i class="fas fa-chart-bar" style="color:var(--gold);font-size:.7rem;"></i>
        Retail Confidence: <strong id="confVal">‚Äî</strong>
      </div>
      <div class="conf-bar"><div class="conf-fill" id="confFill" style="width:0%"></div></div>
      <div class="cat-tags" id="catTags"></div>
    </div>
  </div>

  <!-- Footer / model -->
  <div class="sf">
    <div class="sf-model">
      <div class="sf-model-ico">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
        </svg>
      </div>
      <div class="sf-model-txt">
        <strong>Gemini 2.5 Flash</strong>
        RAG + FAISS Pipeline
      </div>
      <div class="sf-dot"></div>
    </div>
  </div>

</div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="chat-area">

  <header class="chat-header">
    <div class="hdr-left">
      <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
          <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <div class="hdr-brand">
        <div class="hdr-brand-mark">
          <!-- Mini logo mark for header -->
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 24 Q12 24 11 26 L7 52 Q6 54 8 54 H56 Q58 54 57 52 L53 26 Q52 24 50 24 Z" fill="rgba(255,255,255,.15)"/>
            <path d="M22 24 C22 14 42 14 42 24" stroke="white" stroke-width="5" stroke-linecap="round" fill="none"/>
            <circle cx="24" cy="40" r="5" fill="#e8d49a"/>
            <circle cx="40" cy="40" r="5" fill="#e8d49a"/>
            <circle cx="32" cy="49" r="5" fill="#e8d49a"/>
            <line x1="24" y1="40" x2="40" y2="40" stroke="#e8d49a" stroke-width="2.2"/>
            <line x1="24" y1="40" x2="32" y2="49" stroke="#e8d49a" stroke-width="2.2"/>
            <line x1="40" y1="40" x2="32" y2="49" stroke="#e8d49a" stroke-width="2.2"/>
          </svg>
        </div>
        <div class="hdr-brand-text">
          <h2>RetailBot Q&amp;A</h2>
          <p>Ask anything about your retail documents</p>
        </div>
      </div>
    </div>
    <div class="hdr-right">

      <button class="hdr-btn" onclick="clearChat()" title="Clear conversation">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        <span>Clear</span>
      </button>
    </div>
  </header>

  <!-- Messages -->
  <div class="chat-messages" id="chatBox">
    <div class="welcome-state" id="welcomeState">
      <div class="ws-logo">
        <!-- Full logo in welcome -->
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22 Q10 22 9 25 L5 54 Q4 56 7 56 H57 Q60 56 59 54 L55 25 Q54 22 52 22 Z" fill="rgba(255,255,255,.15)"/>
          <path d="M21 22 C21 12 43 12 43 22" stroke="white" stroke-width="5.5" stroke-linecap="round" fill="none"/>
          <circle cx="23" cy="40" r="5" fill="#e8d49a"/>
          <circle cx="41" cy="40" r="5" fill="#e8d49a"/>
          <circle cx="32" cy="50" r="5" fill="#e8d49a"/>
          <line x1="23" y1="40" x2="41" y2="40" stroke="#e8d49a" stroke-width="2.5"/>
          <line x1="23" y1="40" x2="32" y2="50" stroke="#e8d49a" stroke-width="2.5"/>
          <line x1="41" y1="40" x2="32" y2="50" stroke="#e8d49a" stroke-width="2.5"/>
          <circle cx="32" cy="30" r="3.5" fill="#e8d49a" opacity=".6"/>
        </svg>
      </div>
      <h3>Welcome to RetailBot</h3>
      <p>Your AI-powered retail document assistant. Upload a PDF to get started ‚Äî ask about policies, inventory, pricing, and more.</p>
      <div class="ws-grid">
        <div class="ws-card" onclick="suggestQ('What are the store return and refund policies?')">
          <div class="ws-card-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></div>
          <div class="ws-card-text"><strong>Return Policies</strong><span>Refunds &amp; exchanges</span></div>
        </div>
        <div class="ws-card" onclick="suggestQ('How is inventory tracked and managed?')">
          <div class="ws-card-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div>
          <div class="ws-card-text"><strong>Inventory</strong><span>Stock &amp; tracking</span></div>
        </div>
        <div class="ws-card" onclick="suggestQ('What are the pricing guidelines and discount policies?')">
          <div class="ws-card-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
          <div class="ws-card-text"><strong>Pricing</strong><span>Discounts &amp; promos</span></div>
        </div>
        <div class="ws-card" onclick="suggestQ('Summarize the key points of this document')">
          <div class="ws-card-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></div>
          <div class="ws-card-text"><strong>Summarize</strong><span>Key points overview</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-wrap">
    <div class="chips-row">
      <div class="q-chip" onclick="suggestQ('What are the main store policies?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Store policies
      </div>
      <div class="q-chip" onclick="suggestQ('What are employee rules and guidelines?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Employees
      </div>
      <div class="q-chip" onclick="suggestQ('What promotions and discounts are available?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
        Promotions
      </div>
      <div class="q-chip" onclick="suggestQ('How is the POS and checkout process handled?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        POS &amp; Checkout
      </div>
      <div class="q-chip" onclick="suggestQ('What are the vendor and supplier terms?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
        Vendors
      </div>
      <div class="q-chip" onclick="suggestQ('What are the customer service standards?')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Customer Service
      </div>
    </div>

    <div class="input-row">
      <textarea id="question" rows="1" placeholder="Ask about your retail document‚Ä¶" oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
      <div class="input-actions">
        <button class="act-btn" title="Upload a PDF first from the sidebar" onclick="showToast('Upload a retail PDF from the sidebar panel first!','info')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
        </button>
        <button class="send-btn" id="sendBtn" onclick="sendQ()" title="Send (Enter)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="input-hint">
      Press <kbd>Enter</kbd> to send &bull; <kbd>Shift+Enter</kbd> for new line
    </div>
  </div>

</main>
</div>

<script>
  let selFile=null, upFile='', isUp=false, isSend=false, started=false;

  const sidebar    = document.getElementById('sidebar');
  const overlay    = document.getElementById('overlay');
  const dropZone   = document.getElementById('dropZone');
  const fileInput  = document.getElementById('fileInput');
  const filePreview= document.getElementById('filePreview');
  const fpName     = document.getElementById('fpName');
  const fpSize     = document.getElementById('fpSize');
  const fpRm       = document.getElementById('fpRm');
  const uploadBtn  = document.getElementById('uploadBtn');
  const uploadProg = document.getElementById('uploadProgress');
  const uProgBar   = document.getElementById('uProgBar');
  const uStat      = document.getElementById('uStat');
  const docItem    = document.getElementById('docItem');
  const confPanel  = document.getElementById('confPanel');
  const confFill   = document.getElementById('confFill');
  const confVal    = document.getElementById('confVal');
  const catTags    = document.getElementById('catTags');
  const chatBox    = document.getElementById('chatBox');
  const questionEl = document.getElementById('question');
  const sendBtn    = document.getElementById('sendBtn');
  const welcomeEl  = document.getElementById('welcomeState');
  const toastCon   = document.getElementById('toastCon');

  function toggleSidebar(){ sidebar.classList.toggle('open'); overlay.classList.toggle('active'); }
  function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
  document.addEventListener('keydown', e => { if(e.key==='Escape') closeSidebar(); });

  /* FILE */
  fileInput.addEventListener('change', e => pickFile(e.target.files[0]));
  fpRm.addEventListener('click', e => { e.stopPropagation(); clearFile(); });
  ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('dragover'); }));
  dropZone.addEventListener('drop', e => { const f=e.dataTransfer.files[0]; if(f) pickFile(f); });

  function pickFile(file){
    if(!file) return;
    if(!file.name.toLowerCase().endsWith('.pdf')){ showToast('Only PDF files allowed','error'); return; }
    if(file.size > 10*1024*1024){ showToast('File must be under 10 MB','error'); return; }
    selFile=file; fpName.textContent=file.name; fpSize.textContent=(file.size/1024).toFixed(1)+' KB';
    filePreview.classList.add('visible'); hideUstat(); dropZone.style.borderColor='rgba(232,212,154,.6)';
    showToast('File selected ‚Äî click Upload to continue','info');
  }
  function clearFile(){ selFile=null; fileInput.value=''; filePreview.classList.remove('visible'); hideUstat(); dropZone.style.borderColor=''; }

  /* UPLOAD */
  uploadBtn.addEventListener('click', doUpload);
  async function doUpload(){
    if(!selFile){ uploadBtn.style.animation='shake .4s'; setTimeout(()=>uploadBtn.style.animation='',400); showToast('Select a PDF first','error'); return; }
    if(isUp) return;
    isUp=true;
    setUstat('loading','<i class="fas fa-spinner spin" style="font-size:.85rem;"></i> Analyzing document‚Ä¶');
    uploadBtn.disabled=true;
    uploadBtn.innerHTML='<i class="fas fa-spinner spin"></i> Uploading‚Ä¶';
    uploadProg.classList.add('on'); animBar();
    const fd=new FormData(); fd.append('file',selFile);
    try{
      const res=await fetch('/upload',{method:'POST',body:fd});
      const data=await res.json();
      uploadProg.classList.remove('on'); uProgBar.style.width='0%';
      if(res.ok){
        setUstat('success','<i class="fas fa-check-circle"></i> '+data.message);
        showToast('Document processed!','success');
        upFile=selFile.name;
        docItem.innerHTML=`
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;flex-shrink:0">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
            <line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/>
          </svg>
          <span class="doc-name" title="${upFile}">${upFile}</span>
          <span class="doc-badge">Active</span>`;
        docItem.className='doc-item active';
        if(data.retail_classification){
          const rc=data.retail_classification; const c=rc.confidence||85;
          confPanel.classList.add('on'); confFill.style.width=c+'%'; confVal.textContent=c+'%';
          catTags.innerHTML='';
          if(rc.pages) catTags.innerHTML+=`<span class="cat-tag"><i class="fas fa-file-alt" style="font-size:.6rem"></i>${rc.pages} pages</span>`;
          if(rc.chunks) catTags.innerHTML+=`<span class="cat-tag"><i class="fas fa-puzzle-piece" style="font-size:.6rem"></i>${rc.chunks} chunks</span>`;
        }
        hideWelcome();
        addMsg('bot',`üìÑ **Document ready!**\n\n**File:** ${selFile.name}\n**Confidence:** ${data.retail_classification?.confidence||'‚Äî'}%\n\nI've processed your document. Ask me anything!`);
        clearFile();
        if(window.innerWidth<=768) closeSidebar();
      } else {
        setUstat('error','<i class="fas fa-exclamation-circle"></i> '+(data.detail||'Upload failed'));
        showToast('Upload failed','error');
        hideWelcome();
        addMsg('bot','‚ùå **Document Rejected**\n\n'+(data.detail||'Unknown error'));
        clearFile();
      }
    } catch(err){
      uploadProg.classList.remove('on');
      setUstat('error','<i class="fas fa-wifi"></i> Network error: '+err.message);
      showToast('Network error','error');
    } finally {
      isUp=false; uploadBtn.disabled=false;
      uploadBtn.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>Upload Document`;
    }
  }
  function animBar(){ let w=0; const id=setInterval(()=>{ w=Math.min(w+Math.random()*9,88); uProgBar.style.width=w+'%'; if(!uploadProg.classList.contains('on')) clearInterval(id); },280); }
  function setUstat(type,html){ uStat.className='ustat '+type; uStat.innerHTML=html; }
  function hideUstat(){ uStat.className='ustat'; uStat.innerHTML=''; }

  /* CHAT */
  function hideWelcome(){ if(!started){ welcomeEl.style.display='none'; started=true; } }
  function suggestQ(text){ questionEl.value=text; autoResize(questionEl); questionEl.focus(); }

  const nowStr = ()=> new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});

  const USER_AV = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const BOT_AV  = `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
    <path d="M14 24 Q12 24 11 26 L7 52 Q6 54 8 54 H56 Q58 54 57 52 L53 26 Q52 24 50 24 Z" fill="#4a5e42" opacity=".15"/>
    <path d="M22 24 C22 14 42 14 42 24" stroke="#4a5e42" stroke-width="5" stroke-linecap="round" fill="none"/>
    <circle cx="24" cy="40" r="4.5" fill="#4a5e42"/><circle cx="40" cy="40" r="4.5" fill="#4a5e42"/><circle cx="32" cy="49" r="4.5" fill="#4a5e42"/>
    <line x1="24" y1="40" x2="40" y2="40" stroke="#4a5e42" stroke-width="2.2"/>
    <line x1="24" y1="40" x2="32" y2="49" stroke="#4a5e42" stroke-width="2.2"/>
    <line x1="40" y1="40" x2="32" y2="49" stroke="#4a5e42" stroke-width="2.2"/>
  </svg>`;

  function addMsg(sender, text, sources=[]){
    hideWelcome();
    const w=document.createElement('div'); w.className=`message ${sender}`;
    const srcHtml=sources.length?`<div class="msg-sources">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      Pages: ${sources.map(p=>`<span class="src-pill">p.${p+1}</span>`).join('')}</div>`:'';
    w.innerHTML=`<div class="msg-av">${sender==='user'?USER_AV:BOT_AV}</div>
      <div class="msg-body">
        <div class="msg-content">${marked.parse(text)}</div>
        ${srcHtml}
        <div class="msg-time">${nowStr()}</div>
      </div>`;
    chatBox.appendChild(w); scrollDown();
  }

  function addTyping(){
    const d=document.createElement('div'); d.className='message bot'; d.id='typing';
    d.innerHTML=`<div class="msg-av">${BOT_AV}</div><div class="msg-body"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
    chatBox.appendChild(d); scrollDown();
  }
  function removeTyping(){ const el=document.getElementById('typing'); if(el) el.remove(); }
  function scrollDown(){ requestAnimationFrame(()=>chatBox.scrollTop=chatBox.scrollHeight); }

  async function sendQ(){
    const q=questionEl.value.trim(); if(!q||isSend) return;
    if(!upFile){ hideWelcome(); addMsg('bot','‚ö†Ô∏è **Please upload a retail document first** ‚Äî use the sidebar to upload a PDF.'); return; }
    isSend=true; addMsg('user',q); questionEl.value=''; questionEl.style.height=''; sendBtn.disabled=true; addTyping();
    const fd=new FormData(); fd.append('query',q);
    try{
      const res=await fetch('/chat',{method:'POST',body:fd}); const data=await res.json();
      removeTyping();
      if(res.ok) addMsg('bot',data.answer,data.sources||[]);
      else        addMsg('bot','‚ùå **Error:** '+(data.detail||'Unknown error'));
    } catch(err){ removeTyping(); addMsg('bot','‚ùå **Network error:** '+err.message); }
    finally{ isSend=false; sendBtn.disabled=false; questionEl.focus(); }
  }
  function handleKey(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendQ(); } }
  function clearChat(){ chatBox.innerHTML=''; started=false; chatBox.appendChild(welcomeEl); welcomeEl.style.display=''; showToast('Conversation cleared','info'); }
  function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }

  /* TOAST */
  const TICONS={
    success:'<i class="fas fa-check-circle"></i>',
    error:'<i class="fas fa-times-circle"></i>',
    info:'<i class="fas fa-info-circle"></i>'
  };
  function showToast(msg, type='success'){
    const t=document.createElement('div'); t.className=`toast ${type}`;
    t.innerHTML=(TICONS[type]||'')+' '+msg;
    toastCon.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(8px)'; t.style.transition='all .3s'; setTimeout(()=>t.remove(),300); },3200);
  }

  window.addEventListener('load', ()=> questionEl.focus());
</script>
</body>
</html>
